#include <stdio.h>

int blockSize = 512;

// function for getting the length of a string
int getStringLength(char* str) {
	// initializing string length
	int strLength = 0;
	// variable for checking each char in string
	char temp = str[0];
	// iterator variable
	int i = 1;
	while(temp != '\0') {
		temp = str[i];
		// incrementing string length
		strLength++;
		i++;
	}
	return strLength;
}
// converts a given long to a binary string
char* longToBinary(unsigned long num, char* binaryBuffer, int buffer_size) {
	binaryBuffer += (buffer_size-1); // shifting the buffer pointer
	// looping over the buffer and adding binary chars
	for (int i = 64; i >= 0; i--) {
		
		// checking to see what the least significant bit is
		if ( (num & 1) == 0 ) {
			// setting the char value at buffer pointer
			*binaryBuffer = '0';
		} else {
			// setting the char value at buffer pointer
			*binaryBuffer = '1';
		}
		binaryBuffer--; // shifting buffer pointer
		// right shifting num - erase least significant bit
		num >>= 1;
	}
	// return the buffer with binary string
	return binaryBuffer;
}

/*
 * The padding function that pads a given message until it's a multiple of 512
 * and splits the padded message into message blocks of 512 bits
 */
void pad(char* binaryMessage, int sizeBits, char messageBlocks[][blockSize+1], int numBlocks){

	//+1 is added to avoid issues involving edge cases before padding is added and after the
	//'1' separator is added 
	int newSizeBits = sizeBits+1; 
	// makes newSizeBits the size needed to have exactly 64 remaining spots for the size 
	while(newSizeBits%512 != 448){
	    newSizeBits++;
	}
	
	// creating a buffer for the message and padding
	// including the length of the message in bits
	char paddedBuff[newSizeBits+64]; 

    // copies the message into the padded buffer 
	for(int i = 0; i<sizeBits; i++){
	    paddedBuff[i] = binaryMessage[i];
	}	

	printf("\n\n");
	printf("copied message: %s\n", paddedBuff);
	printf("\n\n");

	// adds a trailing '1' after the message and before the padding of 0's
	paddedBuff[sizeBits] = '1'; 
	//pads the buffer up until there are only 64 spots left for the length 
	for(int i = sizeBits + 1; i < newSizeBits; i++){
	    paddedBuff[i] = '0';
	}

	// getting the size of the initial message in 64 bits
	const int BUFFER_SIZE = 65;
	char messageLengthInBinary[BUFFER_SIZE];
	// string ends with null char
	messageLengthInBinary[BUFFER_SIZE-1] = '\0';
	longToBinary(sizeBits, messageLengthInBinary, BUFFER_SIZE-1);

	// appending the length of the initial string in binary
	for (int i = 0; i < 64; i++) {
		paddedBuff[newSizeBits+i] = messageLengthInBinary[i];
	}

	printf("\n\n");
	printf("everything padded: %s\n", paddedBuff);
	printf("\n\n");

	// splitting the string into blocks of 512 bits and null char
	printf("\n\n");
	for (int k = 0; k < numBlocks; k++) {
		for (int j = 0; j < blockSize; j++) {
			messageBlocks[k][j] = paddedBuff[ (k * blockSize) + j];
		}	
		// appending null char to each block
		messageBlocks[k][blockSize] = '\0';
	}
	printf("\n\n");	

}

int main() {
	// test input message
	//char* message = "1101010101010101011010011110001001010001100110101010011001100110011001100110011001101010101010010101010101001001010010010100101010100101001010001010100101010101010101010100010001101111101011011100101010101010101001010101010100101010010101010111111111111101010101010101011010011110001001010001100110101010011001100110011001100110011001101010101010010101010101001001010010010100101010100101001010001010100101010101010101010100010001101111101011011100101010101010101001010101010100101010010101010111111111111010101010101010110100111100010010100011001101010100110011001100110011001100110011010101010100101010101010010010100100101001010101001010010100010101001010101010101010101000100011011111010110111001010101010101010010101010101001010100101010101111111111110000000000000011111111111111110000000000000011111111111101010000000000000001111111111111000000000000000111111111111100000000000000111111111111110000000000000011111111111111111111111111101010101010101010101010101010100000000000000000111111111111111100000000000000011111111111111111000000000000000011111111111111111000000000000001111111111111110000000000000001111111111111100000000000010101010101010101010101001010101011111111111111100000000000000000111111111111111000000000000001111111111111111001010000000000000000000011111111111111110000000000000000111111111111110000000000000000101010100000000000000111111111111111000000000000000111111111111100000000000001010100000000000000000011111111111111111100000000000000000011111111101010101010010101010101010101111";
	char* message = "110101010100010010100011001101010100110011001100110011001100110011010101010100101010101010010010100100101001010101001010010100010101001010101010101010101000100011011111010110111001010101010101010010101010101001010100101010101111111111111010101010101010110100111100010010100011001101010100110011001100110011001100110011010101010100101010101010010010100100101001010101001010010100010101001010101010101010101000100011011111010110111001010101010101010010101010101001010100101010101111111111110101010101010101101001111000100101000110011010101001100110011001100110011001100110101010101001010101010100100101001001010010101010010100101000101010010101010101010101010001000110111110101101110010101010101010100101010101010010101001010101011111111111100000000000000111111111111111100000000000000111111111111010100000000000000011111111111110000000000000001111111111111000000000000001111111111111100000000000000111111111111111111111111111010101010101010101010101010101000000000000000001111111111111111000000000000000111111111111111110000000000000000111111111111111110000000000000011111111111111100000000000000011111111111111000000000000101010101010101010101010010101010111111111111111000000000000000001111111111111110000000000000011111111111111110010100000000000000000000111111111111111100000000000000001111111111111100000000000000001010101000000000000001111111111111110000000000000001111111111111000000000000010101000000000000000000111111111111111111000000000000000000111111111010101010100101010101010101011111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010111101001";
	
	// getting the length of the binary string
	int messageLength = getStringLength(message);

	// finding out how many 512-bit message blocks will be needed
	int numBlocksNeeded = 0;	
	// least length of a message after padding a 1 and the message length 
	int leastPaddedMessageLength = messageLength + 65;

	// last block is 447 bits - will pad to 512 exactly
	if (leastPaddedMessageLength % 512 == 0) {
		numBlocksNeeded = leastPaddedMessageLength / 512;
	} else {
 		// adding one for integer division
		numBlocksNeeded = leastPaddedMessageLength / 512 + 1;
	}

	// creating the array of strings for the message blocks
	char messageBlocks[numBlocksNeeded][blockSize+1];

	// padding the message and getting the message blocks
	pad(message, messageLength, messageBlocks, numBlocksNeeded);

	// printing all of the message blocks
	printf("\n\n");
	for (int i = 0; i < numBlocksNeeded; i++) {
		printf("\n\n");
 		printf ("block %d: %s\n", i, messageBlocks[i]);
	}	
	printf("\n\n");

    return 0;
}

